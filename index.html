<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Authorization Units Calculator</title>
<link href="https://img.icons8.com/ios-filled/32/calculator.png" rel="icon" type="image/png"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#4b5563;
    --primary:#4f46e5;
    --primary-600:#4338ca;
    --ring:rgba(79,70,229,.35);
    --danger:#ef4444;
    --shadow-lg:0 12px 24px rgba(2,6,23,.12);
    --radius:14px;
    --radius-sm:10px;

    /* control sizing */
    --control-height:44px;
    --control-padding-y:10px;
    --control-padding-x:14px;

    /* label baseline height to keep columns aligned */
    --label-line-height:20px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 10% -10%, rgba(79,70,229,.08), transparent 60%),
      radial-gradient(1200px 800px at 110% 10%, rgba(16,185,129,.04), transparent 60%),
      var(--bg);
    padding-bottom:72px;
  }

  .wrap{max-width:880px;margin:48px auto;padding:0 20px}
  .card{
    /* subtle top accent to separate header gradient from background (kept for subtle framing) */
    border-top: 4px solid rgba(79,70,229,0.06);
    background:linear-gradient(180deg, rgba(2,6,23,.02), rgba(255,255,255,0.02)) , var(--card);
    border:1px solid rgba(2,6,23,.04);
    border-radius:var(--radius);
    box-shadow:var(--shadow-lg);
    overflow:hidden;
  }

  /* Darker header gradient to match original visual weight, while keeping controls readable */
  .app-header{
    position:relative;
    padding:28px 28px 24px;
    background:
      linear-gradient(135deg,
        rgba(79,70,229,0.22) 0%,
        rgba(79,70,229,0.14) 28%,
        rgba(255,255,255,0.00) 55%,
        rgba(16,185,129,0.12) 100%);
    border-bottom:1px solid rgba(2,6,23,.06);
    /* ensure pseudo-element is visible over the header background */
    overflow:visible;
  }

  /* thin, slightly translucent blue top stripe to emphasize the header top edge
     matches the button color (var(--primary) -> var(--primary-600)) */
  .app-header::before{
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 8px; /* stripe height, adjust as needed (e.g. 6px or 10px) */
    background: linear-gradient(90deg, rgba(79,70,229,0.98), rgba(67,56,202,0.95));
    border-top-left-radius: var(--radius);
    border-top-right-radius: var(--radius);
    z-index: 2;
    pointer-events:none;
  }

  .app-title{display:flex;align-items:center;gap:12px;font-weight:700;font-size:22px;letter-spacing:.2px;position:relative;z-index:2}
  .app-sub{color:var(--muted);margin-top:6px;font-size:14px;position:relative;z-index:2}

  /* Segmented control: container, track and buttons */
  .segmented {
    display: inline-flex;
    position: relative; /* track will be absolute inside */
    background: rgba(255,255,255,.05);
    border-radius: 999px;
    padding: 4px;
    gap: 6px;
    margin-top: 18px;
    border: 1px solid rgba(2,6,23,.06);
    z-index: 1;
  }

  /* the sliding colored background (track) */
  .segmented-track {
    position: absolute;
    top: 4px;
    height: calc(100% - 8px);
    left: 4px;
    width: 0;
    background: var(--primary);
    border-radius: 999px;
    transition: left 250ms cubic-bezier(.2,.9,.3,1), width 250ms cubic-bezier(.2,.9,.3,1);
    z-index: 0;
    will-change: left, width;
    pointer-events: none;
    box-shadow: 0 6px 18px rgba(79,70,229,.12);
  }

  .segmented button {
    appearance: none;
    border: 0;
    cursor: pointer;
    color: var(--text);
    background: transparent;
    padding: 10px 16px;
    border-radius: 999px;
    font-weight: 600;
    font-size: 14px;
    transition: color 140ms ease;
    position: relative;
    z-index: 2; /* above track so text stays visible */
  }
  .segmented button:hover { color: var(--text); }
  .segmented button.active {
    color: #ffffff; /* active button's text appears white above the track */
  }

  .content{padding:26px;display:grid;gap:24px}

  .grid{display:grid;gap:16px}
  @media (min-width:720px){
    /* ensure labels start at the same vertical position */
    .grid.two{
      grid-template-columns:repeat(2,1fr);
      gap:18px;
      align-items:start;
    }
  }

  /* ensure each control stacks label + input consistently */
  .control{display:flex;flex-direction:column;gap:8px;align-items:stretch;justify-content:flex-start}

  /* force labels to occupy consistent space (so inputs line up) */
  label{
    font-weight:600;font-size:13px;color:var(--muted);margin:0;
    min-height:var(--label-line-height); /* keep labels the same height */
    display:block;
    line-height:1.1;
  }
  label small{font-weight:600;font-size:11px;color:var(--muted);margin-left:6px}

  /* Normalize inputs and selects so they share the same visual size */
  input[type="text"], input[type="number"], select{
    width:100%;
    height:var(--control-height);
    line-height:1.2;
    background:linear-gradient(180deg, rgba(2,6,23,.02), rgba(255,255,255,.02));
    border:1px solid rgba(75,85,99,.12);
    border-radius:12px;
    color:var(--text);
    padding:var(--control-padding-y) var(--control-padding-x);
    outline:none;
    transition:border-color .2s ease, box-shadow .2s ease, transform .04s ease;
    display:flex;
    align-items:center;
    gap:8px;
    box-sizing:border-box;
  }

  select{
    -webkit-appearance:none;
    -moz-appearance:none;
    appearance:none;
    background-image:linear-gradient(45deg, transparent 50%, rgba(0,0,0,.45) 50%), linear-gradient(135deg, rgba(0,0,0,.45) 50%, transparent 50%);
    background-position:calc(100% - 14px) calc(50% - 3px), calc(100% - 8px) calc(50% - 3px);
    background-size:6px 6px,6px 6px;
    background-repeat:no-repeat;
    padding-right:36px;
  }

  input::placeholder{color:#9aa3b2}
  input:focus, select:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
  input.invalid, select.invalid{border-color:var(--danger);box-shadow:0 0 0 4px rgba(239,68,68,.12);background:linear-gradient(180deg, rgba(239,68,68,.03), rgba(239,68,68,.01))}

  .err{color:#b91c1c;font-size:12px;min-height:16px}

  /* ensure consistent spacing above the Calculate button in both modes */
  .actions{display:flex;gap:12px;justify-content:center}
  .actions .btn{ margin: 40px 0; }

  /*
    Button structure: .btn is interactive, .btn-surface is the visual surface, .btn-label is the text.
    Surface will animate independently so the label remains stable and corners render clean.
  */
  .btn{
    appearance:none;
    border:0;
    cursor:pointer;
    background:transparent; /* surface moved to .btn-surface */
    color:white;
    font-weight:700;
    letter-spacing:.2px;
    padding:12px 16px;
    border-radius:12px;
    transition:box-shadow .12s ease, border-color .12s ease;
    position:relative;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    overflow:visible;
    will-change: box-shadow;
    line-height:1;
  }

  /* visual surface (background + elevation). pointer-events:none so clicks hit the button */
  .btn .btn-surface{
    position:absolute;
    inset:0;
    background:var(--primary);
    border-radius:12px;
    box-shadow:0 10px 18px var(--ring);
    z-index:1;
    pointer-events:none;
    transition: box-shadow .12s ease, transform .06s ease;
    transform-origin:center;

    /* Rendering tweaks to avoid corner aliasing/shine */
    background-clip: padding-box;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    transform: translateZ(0);
    will-change: transform, box-shadow;
  }

  .btn .btn-label{
    position:relative;
    z-index:2; /* above surface */
    color:white;
    display:inline-block;
    padding:0 4px;
    user-select:none;
    -webkit-font-smoothing:antialiased;
  }

  .btn[disabled]{ opacity:.6; cursor:not-allowed; box-shadow:none; }

  /* Keep the keyboard focus halo on the button (ring). Remove border to avoid corner highlight artifacts. */
  .btn:focus,
  .btn:focus-visible {
    outline: none;
    border-radius: 12px;
    /* box-shadow moved to the surface so the visible colored surface and the ring align exactly */
  }

  /* Apply the focus halo to the surface instead of the host so the ring hugs the visible surface precisely */
  .btn:focus .btn-surface,
  .btn:focus-visible .btn-surface {
    /* keep the elevation shadow + add an outer ring that matches inputs */
    box-shadow: 0 10px 18px var(--ring), 0 0 0 4px var(--ring);
  }

  /* keyframes for the subtle halo swell (box-shadow on the button surface) */
  @keyframes halo-swell {
    0% { box-shadow: 0 10px 18px rgba(79,70,229,0.35), 0 0 0 3px rgba(79,70,229,0.30); }
    50% { box-shadow: 0 12px 22px rgba(79,70,229,0.22), 0 0 0 6px rgba(79,70,229,0.22); }
    100% { box-shadow: 0 10px 18px rgba(79,70,229,0.35), 0 0 0 4px rgba(79,70,229,0.35); }
  }
  .btn:focus-visible .btn-surface { animation: halo-swell 360ms cubic-bezier(.2,.9,.3,1); }

  /* keyframes for click "pop" that only affects the surface (not the label) */
  @keyframes surface-pop {
    0% {
      transform: scale(1);
      box-shadow: 0 10px 18px var(--ring);
    }
    35% {
      transform: scale(1.04);
      box-shadow: 0 12px 22px rgba(79,70,229,0.22);
    }
    100% {
      transform: scale(1);
      box-shadow: 0 10px 18px var(--ring);
    }
  }

  /* Trigger the surface-pop animation on activation (mouse/touch/keyboard activate).
     We target the surface so the label remains visually static. */
  .btn:active .btn-surface,
  .btn[data-activated="true"] .btn-surface {
    animation: surface-pop 220ms cubic-bezier(.2,.9,.3,1);
  }

  /* segmented control focus ring (no swell) */
  .segmented button:focus,
  .segmented button:focus-visible {
    outline: none;
    box-shadow: 0 0 0 4px rgba(79,70,229,.12);
    border-radius: 999px;
  }

  /* Respect users who prefer reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .btn:focus-visible .btn-surface { animation: none !important; transition: box-shadow .12s ease; }
    .btn:active .btn-surface { animation: none !important; transform: none !important; }
    .segmented button:focus-visible { box-shadow: 0 0 0 4px rgba(79,70,229,.12); }
  }

  .results{display:none;border-top:1px dashed rgba(2,6,23,.06);padding-top:10px;animation:fade .25s ease both}
  @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

  .stats{display:grid;gap:12px}
  @media (min-width:540px){.stats{grid-template-columns:repeat(3,1fr)}}
  .stat{background:linear-gradient(180deg, rgba(2,6,23,.02), rgba(255,255,255,0));border:1px solid rgba(2,6,23,.04);border-radius:var(--radius-sm);padding:14px 14px 12px;display:grid;gap:6px}
  .stat .label{color:var(--muted);font-size:12px;font-weight:600}
  .stat .value{font-size:22px;font-weight:800;letter-spacing:.2px}

  footer{
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    padding:10px 16px;
    text-align:center;
    font-size:13px;
    color:var(--muted);
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(2,6,23,.02));
    border-top:1px solid rgba(2,6,23,.04);
  }
  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header class="app-header">
        <div class="app-title">
          <svg fill="none" height="28" viewbox="0 0 24 24" width="28" xmlns="http://www.w3.org/2000/svg">
            <rect height="18" opacity=".85" rx="4" stroke="currentColor" stroke-width="1.5" width="18" x="3" y="3"></rect>
            <path d="M7 8h4M13 8h4M7 12h10M7 16h4M13 16h4" opacity=".85" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"></path>
          </svg>
          Authorization Units Calculator
        </div>
        <div class="app-sub">Calculate units and visits from a POC date range, or calculate total visits per given units.</div>

        <!-- segmented with sliding track -->
        <div aria-label="Mode" class="segmented" role="tablist" id="segmented">
          <div class="segmented-track" id="segmentedTrack" aria-hidden="true"></div>
          <button aria-selected="true" class="active" id="tab-poc" onclick="switchMode('poc')" role="tab">Units from POC Date Range</button>
          <button aria-selected="false" id="tab-units" onclick="switchMode('units')" role="tab">Visits from Units</button>
        </div>
      </header>

      <section class="content">
        <!-- POC MODE -->
        <div id="poc_mode">
          <div class="grid two">
            <div class="control">
              <label for="start_date">Start Date <small>(MMDDYY)</small></label>
              <input autocomplete="off" id="start_date" inputmode="numeric" placeholder="MMDDYY" type="text"/>
              <div aria-live="polite" class="err" id="start_date_err"></div>
            </div>
            <div class="control">
              <label for="end_date">End Date <small>(MMDDYY)</small></label>
              <input autocomplete="off" id="end_date" inputmode="numeric" placeholder="MMDDYY" type="text"/>
              <div aria-live="polite" class="err" id="end_date_err"></div>
            </div>
          </div>

          <div class="grid two">
            <div class="control">
              <label for="visits_per_week">Visits per Week <small>(1–5)</small></label>
              <select id="visits_per_week" aria-describedby="visits_per_week_err">
                <option value="">Select</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <div aria-live="polite" class="err" id="visits_per_week_err"></div>
            </div>
            <div class="control">
              <label for="duration">Duration per Visit (minutes)</label>
              <select id="duration">
                <option value="">Select</option>
                <option value="30">30</option>
                <option value="45">45</option>
                <option value="60">60</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <!-- Button updated: surface + label so label doesn't scale on click -->
            <button class="btn" onclick="calculatePOC()" id="calculate_poc_btn" aria-label="Calculate POC">
              <span class="btn-surface" aria-hidden="true"></span>
              <span class="btn-label">Calculate</span>
            </button>
          </div>

          <div class="results" id="poc_results">
            <div class="stats">
              <div class="stat"><div class="label">Total weeks</div><div class="value" id="weeks_result">—</div></div>
              <div class="stat"><div class="label">Total units</div><div class="value" id="units_result">—</div></div>
              <div class="stat"><div class="label">Total visits</div><div class="value" id="visits_result">—</div></div>
            </div>
          </div>
        </div>

        <!-- UNITS MODE -->
        <div class="hidden" id="units_mode">
          <div class="grid two">
            <div class="control">
              <label for="units_given">Number of Units Given</label>
              <input id="units_given" placeholder="e.g., 36" type="number"/>
            </div>
            <div class="control">
              <label for="duration_units">Duration per Visit (minutes)</label>
              <select id="duration_units">
                <option value="">Select</option>
                <option value="30">30</option>
                <option value="45">45</option>
                <option value="60">60</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <!-- Button updated here too -->
            <button class="btn" onclick="calculateVisits()" id="calculate_units_btn" aria-label="Calculate Visits">
              <span class="btn-surface" aria-hidden="true"></span>
              <span class="btn-label">Calculate</span>
            </button>
          </div>

          <div class="results" id="units_results">
            <div class="stats">
              <div class="stat" style="grid-column: span 3; max-width: 340px;">
                <div class="label">Total visits</div>
                <div class="value" id="visits_from_units_result">—</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <footer>Developed by Luis R.</footer>

<script>
  /* ==================================
     Logic & Validation (MMDDYY)
     + Sliding segmented control position logic
     ================================== */

  function monthName(m){
    const names = [null,'January','February','March','April','May','June','July','August','September','October','November','December'];
    return names[m] || '';
  }

  function formatWithSlashes(digits){
    const v = digits.replace(/\D/g, '').slice(0, 6);
    if (v.length <= 2) return v;
    if (v.length <= 4) return v.slice(0,2) + '/' + v.slice(2);
    return v.slice(0,2) + '/' + v.slice(2,4) + '/' + v.slice(4);
  }

  function toFullYear(yy) { return yy <= 49 ? 2000 + yy : 1900 + yy; }
  function isLeap(year) { return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0); }

  function parseMMDDYY(digits){
    const v = digits.replace(/\D/g, '');
    if (v.length !== 6) return null;
    const m = Number(v.slice(0,2));
    const d = Number(v.slice(2,4));
    const yy = Number(v.slice(4,6));
    return { m, d, yy, fullYear: toFullYear(yy) };
  }

  function daysInMonth(year, month1to12){ return new Date(year, month1to12, 0).getDate(); }

  function validateMMDDYY(input){
    const v = input.replace(/\D/g, '');
    if (v.length !== 6) {
      return { ok: false, message: 'Please enter 6 digits in MMDDYY format (e.g., 081825).' };
    }
    const p = parseMMDDYY(v); const { m, d, fullYear } = p;
    if (m < 1 || m > 12) return { ok: false, message: 'Month must be 01–12.' };
    const maxDay = daysInMonth(fullYear, m);
    if (d < 1) return { ok: false, message: 'Day must be 01–' + String(maxDay).padStart(2,'0') + '.' };
    if (d > maxDay) {
      if (m === 2 && d === 29 && !isLeap(fullYear)) {
        return { ok: false, message: 'February 29 is only valid in leap years; ' + fullYear + ' is not a leap year.' };
      }
      return { ok: false, message: monthName(m) + " doesn't have " + d + ' days.' };
    }
    return { ok: true, message: '' };
  }

  function toDate(input){
    const v = input.replace(/\D/g, '');
    const res = validateMMDDYY(v);
    if (!res.ok) return null;
    const { m, d, fullYear } = parseMMDDYY(v);
    return new Date(fullYear, m - 1, d);
  }

  function showError(inputId, message){
    const el = document.getElementById(inputId);
    const err = document.getElementById(inputId + '_err');
    if (el) el.classList.add('invalid');
    if (err) err.textContent = message || '';
  }
  function clearError(inputId){
    const el = document.getElementById(inputId);
    const err = document.getElementById(inputId + '_err');
    if (el) el.classList.remove('invalid');
    if (err) err.textContent = '';
  }

  function attachDateMask(inputId){
    const input = document.getElementById(inputId);
    if (!input) return;

    // compute caret position from how many numeric digits are before caret
    function computeCaretFromDigitsCount(digitsBefore, digitsLength){
      const d = Math.min(digitsBefore, digitsLength);
      const slashes = (d > 2 ? 1 : 0) + (d > 4 ? 1 : 0);
      return d + slashes;
    }

    input.addEventListener('input', (e) => {
      const raw = input.value || '';
      // current caret index (in the raw value including slashes)
      const selStart = (typeof input.selectionStart === 'number') ? input.selectionStart : raw.length;
      // how many numeric digits are before the caret
      const digitsBefore = raw.slice(0, selStart).replace(/\D/g, '').length;
      // keep only digits (max 6)
      const digits = raw.replace(/\D/g, '').slice(0, 6);
      const formatted = formatWithSlashes(digits);
      input.value = formatted;

      // compute new caret position accounting for inserted slashes
      const newPos = computeCaretFromDigitsCount(digitsBefore, digits.length);
      try {
        input.setSelectionRange(newPos, newPos);
      } catch (err) {
        // ignore selection errors in some browsers
      }

      clearError(inputId);
    });

    input.addEventListener('blur', () => {
      const digits = input.value.replace(/\D/g, '');
      if (digits.length === 0) { clearError(inputId); return; }
      const res = validateMMDDYY(digits);
      if (!res.ok) showError(inputId, res.message);
      else { input.value = formatWithSlashes(digits); clearError(inputId); }
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (!document.getElementById('poc_mode').classList.contains('hidden')) calculatePOC();
        else calculateVisits();
      }
    });
  }

  /* Sliding segmented track logic */
  function positionSegmentedTrack(animate = true) {
    const seg = document.getElementById('segmented');
    const track = document.getElementById('segmentedTrack');
    if (!seg || !track) return;
    const active = seg.querySelector('button.active');
    if (!active) return;
    const segRect = seg.getBoundingClientRect();
    const btnRect = active.getBoundingClientRect();
    const left = btnRect.left - segRect.left + seg.scrollLeft;
    const width = btnRect.width;
    if (!animate) {
      track.style.transition = 'none';
      track.style.left = left + 'px';
      track.style.width = width + 'px';
      track.getBoundingClientRect();
      track.style.transition = '';
    } else {
      track.style.left = left + 'px';
      track.style.width = width + 'px';
    }
  }

  function switchMode(mode) {
    const poc = document.getElementById('poc_mode');
    const units = document.getElementById('units_mode');
    const tabP = document.getElementById('tab-poc');
    const tabU = document.getElementById('tab-units');
    const showPoc = mode === 'poc';
    poc.classList.toggle('hidden', !showPoc);
    units.classList.toggle('hidden', showPoc);

    // active class and aria-selected
    tabP.classList.toggle('active', showPoc);
    tabU.classList.toggle('active', !showPoc);
    tabP.setAttribute('aria-selected', showPoc ? 'true' : 'false');
    tabU.setAttribute('aria-selected', !showPoc ? 'true' : 'false');

    requestAnimationFrame(() => positionSegmentedTrack(true));

    document.getElementById('poc_results').style.display = 'none';
    document.getElementById('units_results').style.display = 'none';
  }

  function validatePOCInputs(){
    let valid = true;
    const required = ['start_date','end_date','visits_per_week','duration'];
    required.forEach(id => {
      const el = document.getElementById(id);
      if (!el.value) {
        if (id === 'start_date' || id === 'end_date') showError(id, 'This field is required.');
        else if (id === 'visits_per_week') showError(id, 'This field is required.');
        else el.classList.add('invalid');
        valid = false;
      } else {
        if (id === 'start_date' || id === 'end_date') clearError(id);
        else if (id === 'visits_per_week') clearError(id);
        else el.classList.remove('invalid');
      }
    });

    ['start_date','end_date'].forEach(id => {
      const digits = document.getElementById(id).value.replace(/\D/g, '');
      if (digits.length > 0) { const res = validateMMDDYY(digits); if (!res.ok) { showError(id, res.message); valid = false; } }
    });

    const vpwEl = document.getElementById('visits_per_week');
    if (vpwEl.value) {
      const n = Number(vpwEl.value);
      if (isNaN(n) || !Number.isInteger(n) || n < 1 || n > 5) {
        showError('visits_per_week', 'Visits per week must be an integer between 1 and 5.');
        valid = false;
      } else {
        clearError('visits_per_week');
      }
    }

    // Robust comparison: parse both MMDDYY and compare YYYYMMDD numerically
    const startDigits = document.getElementById('start_date').value.replace(/\D/g, '');
    const endDigits = document.getElementById('end_date').value.replace(/\D/g, '');
    const sP = parseMMDDYY(startDigits);
    const eP = parseMMDDYY(endDigits);
    if (sP && eP) {
      const sVal = sP.fullYear * 10000 + sP.m * 100 + sP.d;
      const eVal = eP.fullYear * 10000 + eP.m * 100 + eP.d;
      // Require end to be strictly greater than start (at least one day after)
      if (eVal <= sVal) {
        showError('end_date', 'End Date must be at least one day after Start Date.');
        valid = false;
      } else {
        // ensure any previous end_date error is cleared
        clearError('end_date');
      }
    }

    return valid;
  }

  function calculatePOC(){
    if (!validatePOCInputs()) { alert('Please correct the highlighted fields.'); return; }
    const visitsPerWeek = parseInt(document.getElementById('visits_per_week').value, 10);
    const duration = parseInt(document.getElementById('duration').value, 10);
    const startDate = toDate(document.getElementById('start_date').value);
    const endDate = toDate(document.getElementById('end_date').value);
    if (!startDate || !endDate) { alert('Enter valid dates in MMDDYY format.'); return; }

    const msPerWeek = 1000 * 60 * 60 * 24 * 7;
    const weeks = Math.round(Math.abs((endDate - startDate) / msPerWeek));
    const totalVisits = Math.round(visitsPerWeek * weeks);
    const totalUnits = Math.round(visitsPerWeek * (duration / 15) * weeks);

    document.getElementById('weeks_result').textContent = weeks;
    document.getElementById('units_result').textContent = totalUnits;
    document.getElementById('visits_result').textContent = totalVisits;
    document.getElementById('poc_results').style.display = 'block';
  }

  function validateUnitsInputs(){
    let valid = true; const fields = ['units_given','duration_units'];
    fields.forEach(id => { const el = document.getElementById(id); if (!el.value) { el.classList.add('invalid'); valid = false; } else el.classList.remove('invalid'); });
    return valid;
  }

  function calculateVisits(){
    if (!validateUnitsInputs()) { alert('Please fill in all fields.'); return; }
    const units = parseFloat(document.getElementById('units_given').value);
    const duration = parseFloat(document.getElementById('duration_units').value);
    const visits = Math.round(units / (duration / 15));
    document.getElementById('visits_from_units_result').textContent = visits;
    document.getElementById('units_results').style.display = 'block';
  }

  /* 
    Ensure keyboard activation also triggers the surface animation —
    some browsers don't apply :active for keyboard activations.
  */
  document.addEventListener('keydown', (e) => {
    const target = e.target;
    if (!(target instanceof HTMLElement)) return;
    if (target.classList && target.classList.contains('btn')) {
      if (e.key === 'Enter' || e.key === ' ') {
        target.setAttribute('data-activated', 'true');
        setTimeout(() => target.removeAttribute('data-activated'), 300);
      }
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    // date masks
    attachDateMask('start_date');
    attachDateMask('end_date');

    // ensure segmented track is positioned on load WITHOUT animating
    positionSegmentedTrack(false);

    // reposition on resize
    window.addEventListener('resize', () => positionSegmentedTrack(false));

    // keyboard support for segmented control
    const seg = document.getElementById('segmented');
    seg.addEventListener('keydown', (e) => {
      const focusable = Array.from(seg.querySelectorAll('button'));
      const idx = focusable.indexOf(document.activeElement);
      if (e.key === 'ArrowRight') {
        const next = focusable[(idx + 1) % focusable.length];
        next.focus();
        next.click();
        e.preventDefault();
      } else if (e.key === 'ArrowLeft') {
        const prev = focusable[(idx - 1 + focusable.length) % focusable.length];
        prev.focus();
        prev.click();
        e.preventDefault();
      }
    });
  });
</script>
</body>
</html>
