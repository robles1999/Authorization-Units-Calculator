<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Authorizations Units Calculator</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/32/calculator.png">
    <style>
        /* Created by Luis R. */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding-bottom: 60px;
            background-color: #f4f6f8;
        }
        .container {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 15px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        input.invalid, select.invalid {
            border-color: red;
            background: #fff5f5;
        }
        .err {
            color: #c62828;
            font-size: 0.85rem;
            margin-top: 4px;
            min-height: 1em; /* reserve space so layout doesn't jump */
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            margin-top: 20px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .results {
            margin-top: 20px;
            display: none;
            background: #e9f5ff;
            padding: 15px;
            border-radius: 5px;
        }
        .mode-switch {
            text-align: center;
            margin-bottom: 20px;
        }
        .mode-switch button {
            width: auto;
            margin: 5px;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f8f9fa;
            color: #333;
            text-align: center;
            padding: 10px 0;
            font-size: 14px;
            font-family: Arial, sans-serif;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Authorizations Units Calculator</h2>
        <div class="mode-switch">
            <button onclick="switchMode('poc')">Units from POC Date Range</button>
            <button onclick="switchMode('units')">Visits from Units</button>
        </div>

        <div id="poc_mode">
            <label for="start_date">Start Date (MMDDYY):</label>
            <input type="text" id="start_date" inputmode="numeric" autocomplete="off" placeholder="MMDDYY">
            <div class="err" id="start_date_err" aria-live="polite"></div>

            <label for="end_date">End Date (MMDDYY):</label>
            <input type="text" id="end_date" inputmode="numeric" autocomplete="off" placeholder="MMDDYY">
            <div class="err" id="end_date_err" aria-live="polite"></div>

            <label for="visits_per_week">Visits per Week (0-5):</label>
            <input type="number" id="visits_per_week" min="0" max="5" step="1">

            <label for="duration">Duration per Visit (minutes):</label>
            <select id="duration">
                <option value="">Select</option>
                <option value="30">30</option>
                <option value="45">45</option>
                <option value="60">60</option>
            </select>

            <button onclick="calculatePOC()">Calculate</button>

            <div class="results" id="poc_results">
                <p id="weeks_result"></p>
                <p id="units_result"></p>
                <p id="visits_result"></p>
            </div>
        </div>

        <div id="units_mode" style="display:none;">
            <label for="units_given">Number of Units Given:</label>
            <input type="number" id="units_given">

            <label for="duration_units">Duration per Visit (minutes):</label>
            <select id="duration_units">
                <option value="">Select</option>
                <option value="30">30</option>
                <option value="45">45</option>
                <option value="60">60</option>
            </select>

            <button onclick="calculateVisits()">Calculate</button>

            <div class="results" id="units_results">
                <p id="visits_from_units_result"></p>
            </div>
        </div>
    </div>

    <footer>Created by Luis R.</footer>

    <script>
        /* ============================
           Date helpers (MMDDYY)
           Created by Luis R.
           ============================ */

        function monthName(m) {
            const names = [null,'January','February','March','April','May','June','July','August','September','October','November','December'];
            return names[m] || '';
        }

        // Formats "MMDDYY" digits into "MM/DD/YY" as you type
        function formatWithSlashes(digits) {
            const v = digits.replace(/\D/g, '').slice(0, 6);
            if (v.length <= 2) return v;
            if (v.length <= 4) return v.slice(0,2) + '/' + v.slice(2);
            return v.slice(0,2) + '/' + v.slice(2,4) + '/' + v.slice(4);
        }

        // Convert 2-digit year to full year using a pivot (00–49 => 2000–2049; 50–99 => 1950–1999)
        function toFullYear(yy) {
            return yy <= 49 ? 2000 + yy : 1900 + yy;
        }

        function isLeap(year) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }

        // Parse "MMDDYY" (digits only). Returns {m,d,yy,fullYear} or null if not 6 digits.
        function parseMMDDYY(digits) {
            const v = digits.replace(/\D/g, '');
            if (v.length !== 6) return null;
            const m = Number(v.slice(0,2));
            const d = Number(v.slice(2,4));
            const yy = Number(v.slice(4,6));
            return { m, d, yy, fullYear: toFullYear(yy) };
        }

        function daysInMonth(year, month1to12) {
            return new Date(year, month1to12, 0).getDate();
        }

        // Detailed validation with messages:
        // - Only mention the YEAR when it's Feb 29 in a non-leap year.
        // - All other month/day issues omit the year (e.g., "September doesn't have 31 days.")
        function validateMMDDYY(input) {
            const v = input.replace(/\D/g, '');
            if (v.length !== 6) {
                return { ok: false, message: 'Please enter 6 digits in MMDDYY format (e.g., 081825).' };
            }
            const p = parseMMDDYY(v);
            const { m, d, fullYear } = p;

            if (m < 1 || m > 12) {
                return { ok: false, message: 'Month must be 01–12.' };
            }
            const maxDay = daysInMonth(fullYear, m);
            if (d < 1) {
                return { ok: false, message: 'Day must be 01–' + String(maxDay).padStart(2,'0') + '.' };
            }
            if (d > maxDay) {
                if (m === 2 && d === 29 && !isLeap(fullYear)) {
                    // Only here we include the year in the message
                    return { ok: false, message: 'February 29 is only valid in leap years; ' + fullYear + ' is not a leap year.' };
                }
                // All other cases: month name only, no year
                return { ok: false, message: monthName(m) + " doesn't have " + d + ' days.' };
            }
            return { ok: true, message: '' };
        }

        // Converts "MMDDYY" or "MM/DD/YY" to a Date; returns null if invalid
        function toDate(input) {
            const v = input.replace(/\D/g, '');
            const res = validateMMDDYY(v);
            if (!res.ok) return null;
            const { m, d, fullYear } = parseMMDDYY(v);
            return new Date(fullYear, m - 1, d);
        }

        function showError(inputId, message) {
            const el = document.getElementById(inputId);
            const err = document.getElementById(inputId + "_err");
            if (el) el.classList.add("invalid");
            if (err) err.textContent = message || "";
        }

        function clearError(inputId) {
            const el = document.getElementById(inputId);
            const err = document.getElementById(inputId + "_err");
            if (el) el.classList.remove("invalid");
            if (err) err.textContent = "";
        }

        // Attach date masking + validation to inputs by id
        function attachDateMask(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;

            input.addEventListener('input', () => {
                const digits = input.value.replace(/\D/g, '').slice(0, 6);
                input.value = formatWithSlashes(digits);
                clearError(inputId);
            });

            input.addEventListener('blur', () => {
                const digits = input.value.replace(/\D/g, '');
                if (digits.length === 0) {
                    clearError(inputId);
                    return;
                }
                const res = validateMMDDYY(digits);
                if (!res.ok) {
                    showError(inputId, res.message);
                } else {
                    input.value = formatWithSlashes(digits);
                    clearError(inputId);
                }
            });
        }

        /* ============================
           Existing app logic + updates
           ============================ */

        function switchMode(mode) {
            document.getElementById("poc_mode").style.display = mode === "poc" ? "block" : "none";
            document.getElementById("units_mode").style.display = mode === "units" ? "block" : "none";
            document.getElementById("poc_results").style.display = "none";
            document.getElementById("units_results").style.display = "none";
        }

        function validatePOCInputs() {
            let valid = true;

            // Required checks
            const requiredFields = ["start_date", "end_date", "visits_per_week", "duration"];
            requiredFields.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value) {
                    if (id === "start_date" || id === "end_date") {
                        showError(id, "This field is required.");
                    } else {
                        el.classList.add("invalid");
                    }
                    valid = false;
                } else {
                    if (id === "start_date" || id === "end_date") {
                        clearError(id);
                    } else {
                        el.classList.remove("invalid");
                    }
                }
            });

            // Date validity checks with detailed messages
            ["start_date", "end_date"].forEach(id => {
                const val = document.getElementById(id).value;
                const digits = val.replace(/\D/g, '');
                if (digits.length > 0) {
                    const res = validateMMDDYY(digits);
                    if (!res.ok) {
                        showError(id, res.message);
                        valid = false;
                    }
                }
            });

            // Visits per week range check (0–5)
            const vpwEl = document.getElementById("visits_per_week");
            if (vpwEl.value) {
                const n = Number(vpwEl.value);
                if (isNaN(n) || n < 0 || n > 5) {
                    vpwEl.classList.add("invalid");
                    alert("Visits per Week must be between 0 and 5.");
                    valid = false;
                }
            }

            // Ensure start <= end when both valid
            const startDate = toDate(document.getElementById("start_date").value);
            const endDate   = toDate(document.getElementById("end_date").value);
            if (startDate && endDate && endDate < startDate) {
                showError("end_date", "End Date must be on or after Start Date.");
                valid = false;
            }

            return valid;
        }

        function calculatePOC() {
            if (!validatePOCInputs()) {
                alert("Please correct the highlighted fields.");
                return;
            }

            const start = document.getElementById("start_date").value;
            const end = document.getElementById("end_date").value;
            const visitsPerWeek = parseInt(document.getElementById("visits_per_week").value, 10);
            const duration = parseInt(document.getElementById("duration").value, 10);

            const startDate = toDate(start);
            const endDate = toDate(end);

            if (!startDate || !endDate) {
                alert("Enter valid dates in MMDDYY format.");
                return;
            }

            const msPerWeek = 1000 * 60 * 60 * 24 * 7;
            const weeks = Math.round(Math.abs((endDate - startDate) / msPerWeek));
            const totalVisits = Math.round(visitsPerWeek * weeks);
            const totalUnits = Math.round(visitsPerWeek * (duration / 15) * weeks);

            document.getElementById("weeks_result").textContent = `Total weeks: ${weeks}`;
            document.getElementById("units_result").textContent = `Total units: ${totalUnits}`;
            document.getElementById("visits_result").textContent = `Total visits: ${totalVisits}`;
            document.getElementById("poc_results").style.display = "block";
        }

        function validateUnitsInputs() {
            let valid = true;
            const fields = ["units_given", "duration_units"];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value) {
                    el.classList.add("invalid");
                    valid = false;
                } else {
                    el.classList.remove("invalid");
                }
            });
            return valid;
        }

        function calculateVisits() {
            if (!validateUnitsInputs()) {
                alert("Please fill in all fields.");
                return;
            }

            const units = parseFloat(document.getElementById("units_given").value);
            const duration = parseFloat(document.getElementById("duration_units").value);
            const visits = Math.round(units / (duration / 15));

            document.getElementById("visits_from_units_result").textContent = `Total visits: ${visits}`;
            document.getElementById("units_results").style.display = "block";
        }

        // Initialize date masks on load
        document.addEventListener('DOMContentLoaded', () => {
            attachDateMask('start_date');
            attachDateMask('end_date');
        });
    </script>
</body>
</html>
